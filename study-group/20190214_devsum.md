# デブサミ 20190214

## レガシー開発からモダン開発への挑戦

- ブロードリーフ
  - 自動車アフターマーケット
    - 新車販売市場(自動車メーカー)後の市場
      - GS、保険、部品
  - 東京、福岡、札幌

- オンプレ時代
  - 合計190サーバくらい
  - ほぼwindows

- infrastructures as Code (IaC)
  - ソフトウェア開発のプラクティスをインフラのオートメーションに活かすアプローチ
  - システムのプロビショ人ぐと構成・設定、およびその変更において統一的で反復可能なルーチンに重さを置く
  - 変更は定義になり、徹底的な検証を含む無人プロセスを通じてシステムにロールアウトされる
  - Terraform
    - インフラ構成管理ツール
    - Go言語で書かれている、win,mac,linux動作
    - ベンダーロックインが避けられる
    - Issueを上げてから2week程度で改善された
    - パブリッククラウドのリソースのみの管理しかできていない
    - dev, stage, prodの環境構築が容易になった

- GCPを使った
  - フロントエンド.バックエンドはGKE
  - Ansible
    - Pythonで書かれている。mac, Linuxで使える
    - 捜査対象となるVMはエージェントが不要
    - TerraformのようにパブリッククラウドのリソースやCiscoなどNW機器の設定にも適用できる
    - YAMLで書く
    - 冪等性が担保されているので何度実行しても同じ構成になる

- Packer
  - インフラ構成管理ツール
  - terraformと同じ会社
  - Builderによりパブリッククラウド、OpenStackなど様々なイメージを作成できる
  - ProvisionerによりAnsible,Chefなどの既存ツールの設定を読み込むことも可能
  - まだ検証中

- 自動復旧
  - オペミスが防げる
  - ダウンタイムの短縮
  - オンコールによる工数削減
    - アラートに怯える生活からの脱却
  - 自動復旧構成例
    - 障害発生時にアラートを受け取ることが目的ではない
    - いち早く、復旧させる行動を取るためにアラートを受け取る

- やったことのないPDCAは成立しない
  - 特にPlanは作れない
  - いち早くDoをしないとPlanを構築できない

- Spring Bootを使ってマイクロサービスを構築した話
  - マイクロサービスでもSpringBootでいいのか？
  - マイクロサービスっぽいサービス開発

- アプリケーションの起動が遅い
  - 速く動作確認したいけど、中途半端に待たされる
  - Gitlab RunnerのPIPELINEがつまる
  - PodがOOMとかで落ちちゃった際の修復時間に直結して遅くなる
  - CPUの割り当てが潤沢ではない
    - limit: 600ms
  - 膨大なクラス数のロード（約14000)
  - やれることをやる
    - JDK11へのアップグレード
    - spring-context-indexer
    - Application Class-Data sharingを導入する

- テストが遅い  
  - Java起動時のオプションチューニング
    - TieredStopAtLebel=1
    - TierdCompilation
  - Maven Surefire pluginのreuseForksをtrueに変更
  - Spring BootのIssue#10366を回避するためにfalseにしていた

- Metaspaceの領域
- Spring bootでDynamic Configuration最初から意識しておかないと運用がしんどい
- Spring Clound k8xに期待

- Micronaut
  - DI APIをコンパイル時に解決
  - native-image化できる
  - Apache Kafka, Cassandraにも対応

## Cloud Native時代における Docker / Kubernetes による開発

- Clound Native and k8s
  - CNNCはLinux Foundationのサブプロジェクト
    - Clound Native Ecosystemはk8sを前提としたプロジェクトが多い

- Microservice and Service Mesh
  - マイクロサービス : モノシリックアーキテクチャ
  - 対になるもの
  - 大規模な開発を加速させる
  - スケーリングが用意
  - 障害が全体に波及しにくい
    - サーキットブレークってやつだな
  - netflix, twitterは500以上のサービスで構築されている
  - microservice with service meth
    - 各サービスに直接アクセスするのではなくProxyを挟む
    - microservice間通信のモニタリング
    - Traffic Shifting (カナリアリリース、blue/green　リリースとか)
  - Circuit break
  - Fault Injection
  - rate limit
  - retry
  - mTLS
    - アプリケーション側で行っていたことをproxyで行うことができる。アプリ開発者はサービスの開発のみに集中できる

- Container and Docker
  - VMでもできるけど管理が大変
  - Container
    - System Container
    - Application Container
      - 流行っているのはこっち
  - Dockerコンテナの起動
    - 既存レイヤをまとめてReadOnlyで作り、Write可能なレイアを付け加える

- k8s overview
  - 複数台の渾天を管理する？
  - Container Orchestration Engine
    - 複数のDokcerホストの管理
    - コンテナのスケジューリング
    - スケーリング/オートスケーリング
    - ローリングアップデート
    - コンテナの死活管理
  - k8sは複数のコンテナホストの管理を行う。（Dockerホストの管理ではない）
  - prod環境でDockerコンテナを単体で利用することは考えられない。

- k8sが齎すもの
  - Declarative Code And APIs
    - 全ての情報をYAMLで管理する
    - サービスの外部公開
      - 転送先のポート番号と対象とする渾天を指定
      - コンテナのLabelはLBの設定でどこのコンテナに繋げるかを記載する
  - ReplicaSetとSelf-Healing
    - NOde障害なおでコンテナが不足した場合に別のNodeで立ち上げる
  - ReplicaSetとRolling Update
    - ロードバランサーからの除外
    - コンテナイメージのアップデート
    - ロードバランサへの追加
  - k8sでだいたい解決できる

- k8s is Framework and Distributed System
  - マニフェストの登録を行うと何かしら動く。
    - Control Loop
      - 現在の状態を観測
      - 現在の状態とリクエストされた状態を比較する
      - 差分に対処する処理を行う
  - Custom Resource Definition
    - k8sをk8sで管理している。(Yahooとか)
    - ここがHot Topic

- k8s for enterprise
  - イギリスのインターネット銀号で採用されている
- k8sはCloundのLinuxの立ち位置になるのではないのかと言われている

- Feture k8s



## 新技術導入を成功させる組織のつくりかた ～spanner、GKE導入の実体験から得たこと～

- コロプラの組織構成
  - 事業部体制から機能別組織に変更した
    - ノウハウの共有などに問題が出てきたため
- コロプラのエンジニアリングから見た特徴
  - これまで出してきたゲームは会hつしない
  - 基本的にサーバーメンテナンスは行わない
  - 他プラットフォームに移行できない技術は使わない
- 利用しているテクノロジー
  - ZendFramework -> Laravel
    - 不良機能の棚卸し、
    - 二重管理が始まってしまった
  - mySQL on VM -> Google Clound Spanner
    - スケールダウン/アウトじのオペレーションコストの圧倒的な削減、高い可溶性
    - ノウハウがあまりない、ローカルエミュレータがないのでローカル開発のコストが高い
  - VM -> GKE
    - オートヒール/オートスケール
    - デプロイ時間にかかる時間の増加
  - 最近リリースされた2タイトルが対象

- コロプラが抱えていた問題点
  - FWのサポートがキレそう

  - 新しいタイトルは最新のタイトルからコードをコピー
    - 不具合がどこから発生したかわかりにくい問題
  - ライブラリの作りが甘く、各タイトルで変更が入ると収集がつかなくなる

  - 運用の課題
    - メンテナンスしないはかなり大変
    - MySQLが動いているVMのメンテがきたらオンラインでDBの入れ替え
    - 単一で動いていたDBのスケールアウト（シャーディング化）もかつてはメンテなしで実施
    - jsox

- 新しい技術を導入することになった経緯や、やったこと
  - FWのサポートが切れた！
    - 会社にかける人がたくさんいるPHPを洗濯
    - LaravelはLTSがあるのがいい
  - GCPへの移行
    - GCPのLive Migrationをはじめとする高いテクノロジーを使うことが大きな理由
    - マネージドサービスを積極的に使っていく方針
  - Clound Spanner
    - DBを含めたノーメンテに対しての課題を解決してくれるのはこれしかない
    - 分散型KVSという選択肢もあったけど、SQLって便利じゃん

- サーバ基盤チーム結成
  - 運用するためのツールなどの作成者が足りなかった
    - アプリ開発では工数は十分だったが、運用に関する工数の目算が甘かった？

- そこで得られた知見
  - 新技術を導入するにあたっての壁
    - 既存の仕事でいっぱいで新しい技術に取り組む人員がいない
    - エンジニアが余っている会社はいない
      - 成功するかわからないとこに人をアサインすることは不安がある
      - 既存システムへの影響がないようにしたいけど、影響する
    - 未来への投資はいつだって足下の業務に影響しますが、未来への投資をやめることで未来の足下はもっと悪くなる
  - 新しい技術に挑戦する人がいない
    - 素養のある人は絶対にいる
    - 経験はないけど新しい技術に興味のある若者をスカウト
  - 短いスケジュール
    - 新しい技術がスケジュールに間に合う華道家はマネージメンtによる部分もそれなりに大きい
    - 必要な昨日に優先順位を守らせることが大事
  - 本番導入での障害
    - SpannerのHotspot障害を起こしてしまい数時間のサービスダウンした
  - オーバーエンジニアリングとの戦い
    - 期日やコスト、問題の事象が発生する確率、発生した時のリスクの大きさなどを考慮して時にはやらないという選択肢を取ることが大事
  - 新技術導入で得られた気づき
    - 学生時代にインフォメーションテクノロジーを学んできた新卒は優秀
    - チャレンジしてもらうことで新人からシニア層になれる可能性がある
    - 経験ある人だけでやろうとしていませんか？
      - 未経験者を参加させることで未来への可能性は広がる
    - プロダクションで使うときは事業課題にフィットしていることが重要
  - 小さな変化を積み重ねて大きな変化につなげよう
  - 行けると思った時にアクセルは強めに踏んだ方がいい
  - 最終目標を常に共有し続けよう
    - メリットは目標を雑談レベルでも共有していくことが大事（雑談レベルでもいいから）


## レガシーとのいい感じの付き合い方 〜15年続くウェブサービスのシステム改善パターン〜

- ECナビで2004年から稼働しているシステム
- 改善事始め
  - 事業ライフサイクルが成長期から成熟期に差し掛かり始めた
  - 収益成長 onlyから業務改善を加えた
  - 問題点
    - 古くて大規模
    - 1089機能+900table
    - 旧管理系のサーバがカオス
    - 200x年からメンテ放置
    - インフラがオンプレ
    - データセンター撤退の予兆
    - エンジニア新規採用苦戦
    - 在籍エンジニアのモチベーションDown
  - 調査
    - 4-5人で調査とヒアリング
    - 機能一覧
      - 機能とパスを調べ上げ分類をつけて一覧形式に
  - 葬り
    - 不要な機能を削除すること
    - 問題の分母を手間をかけずに減らせる
    - 1/3ほど減らせることができた
    - コード量については半分
  - 無理をしない方針
    - 長期で段階的に改善
    - 取り組む問題は絞る
  - 問題選定
    - 自由なインフラ
    - AWS移行
    - 開発しやすい環境整備
    - 先送り
      - アプリケーションの見直し

- ECナビAWS移行
  - 移行方針
    - そのまま持っていく
      - アプリケーションのアーキテクチャ
      - サーバ構成、ミドルウェア
      - 監視、ログ収集
  - 移行方法
    - web -> ec2
    - MySQL -> RDS MySQL
    - Oracle -> RDS Oracle
  - Oracleの移行方法
    - Enterprise Edition & RAC & アプライアンス
    - RDS上での構成、コスト感
  - Oracle 移行検証
    - ランニングコストの問題
      - 月に数百万規模(手痛い出費)
      - Standart Edition（月に数十万）
      - ダウングレードを検討
  - Oracle ダウングレード検証ポイント
    - 機能さ
      - パフォーマンス情報収集
      - メンテナンス作業も必須
    - パフォーマンスは問題なかった
  - システム移行
    - やること
      - 開発しやすい環境整備に必要なことのみ
      - コントロール可能にすること
        - AWSのリソース構築/変更
        - EC2のプロビジョニング
  - インフラはコード化する
    - AWSリソース構築トプロビジョニングヲ運用していくために
    - CloundFormationテンプレートでコード化
    - sandbox環境と本番環境を用意
      - 試しやすく
      - 本番はsandboxで作った構成を再現すれば良い
  - プロビジョニング
    - Puppetマニフェストで管理
    - Pupperのバージョンを最新に上げた
    - CircleCIでマニフェストの適用を試すことができるようにした

  - まとめ
    - やることを厳選し短期間で移行した
    - インフラの改善が進みやすくなった

- 旧管理系AWS移行
  - 