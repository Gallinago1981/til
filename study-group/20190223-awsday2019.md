# jaws day 2019

## 今日から始めるCI/CDのアーキテクチャ事始め

- jaws-ug arch
  - conpassで受付

- 夫婦げんかから始まるci/cd
  - 夫: アプリ開発 / 妻: インフラ開発
  - 開発環境
    - svn, GitLab
    - PHP, Phalcon
    - デプロイは手動
- CI/CD
  - リリースには承認が必要
  - 1台から2台に増やすのも手動
  - 導入するメリットが見つからない
  - インフラ視点
    - 手動スケールではなくAUtoScallingしたい
    - インスタンスを多めに取っている
    - BlueGreenしたい
    - 将来的にコンテナ/マイクロサービスが行いたい
  - アプリ側
    - インスタンスが必要なものもあるけど稀

- CI/CDとAuto Scalingとは違うよね
  - コンテナだったら話は変わってくる
  - Docker Imageのビルド

- CI と　CDを分けてみたら
  - Continuous Integration
    - バグへの早期対策
    - ソフトウェアの品質を高める
  - Continuous Delivery/Deployment
    - delivaery
      - 承認がないとリリースされない
  - CDの目的の違い
    - どちらもユーザからのフィードバックを早く得ること
  - システムの品質向上を目的とする
- CDから始める方がお手軽
  - CIもCDも一気に導入は考えることがたくさん
  - 既存プロジェクトに後からCI導入は難しい
  - CIやるにはテストコードが必要なのでデプロイだけでも自動化してみたら楽になるのでは
  - 非コンパイル言語ならCDだけでもやってみる価値はあり
  - リリース頻度が１システム週２回以上あるならなおさら
- まとめ
  - CI と CDの違いをちゃんと認識しよう
  - 現状の組織や組織内の役割分担

- CI/CDはもう当たり前だよね
- CI/CDやった方がいいのはわかるけど、どこからやったらいいかわからないけどね
- AWSサービスの全体像
  - CodeCommit/CodeBuild/CodeDeploy
  - CodePipline
    - CodeStar
      - お試しの環境としては面白い
      - 上のサービスが全部つかえる
  - CodeCommit
    - github相当のサービス
    - IAMユーザごとにアクセス制御できる
    - issue管理はない
    - 競合サービス
      - GitHub, Bzitbucket
      - SE
  - CodeBuild
    - buildspec.ymlに書いたことをなんでもできる
    - やりすぎると秘伝のタレになってしまう
    - 連携サービス
      - CodePipleはIN/ONTノサービスそれぞれ認識している必要がある
      - buildspec.ymlに記載した場所にpushすることができる（ECR）
  - CodeDeploy
    - deployエージェントの入っているEC2やオンプレにデプロイ
    - Lambda, ECSへのデプロイに対応
    - 最初にアプリケーションの箱を作る際にデプロイ先を指定するがあとで変更できない
  - CodePipeline
    - CI/CDをつなぐ役割
    - 基本的にJSONで構成をかく
    - マルチソース対応
    - CloudWatch Eventsに対応
      - Input側に変更があった場合に即時にキックされるようになった
- ツールに自分達に合わせるのではなく自分たちのパイプラインにツールを組み込む
  - 自分達のパイプラインを決めないとツールに引っ張られてしまう
  - パイプラインを作る目的はなんなのかを常に意識することが重要
- CI/CDのデザインマップ
  - パイプラインの先にユーザがいないと意味がない
  - ユーザとは？
    - お金を払う人たち
    - システムの発注者ではない？
  - 見えてきた形
    - テストビルド
      - 中間成果物が必要となる
      - ゴミが残る

## RDBリファクタリングと異種姦DB移行の戦い
- 壮大な落書き帳というブログを探してみる
- Amazon DMSを使ってサービスを止めずにリファクタリングする方法
  - データベースリファクタリングやってますか？
    - アプリケーションの修正が必要
      - 影響範囲が広い
    - データベースの寿命はアプリより長い
  - エンジニアHUBへ寄稿している

- リファクタリングする理由
  - 1年半あればシステムは大幅に変わる
  - 誰も知らないテーブルの恐怖
  - 変化に伴って技術負債ができやすい
    - 負債ができるのは仕方ない。どう向き合うかが大切
    - 非正規化するとSELECTは早いけど、ソースコード/INSERT/UPDATEは遅い
  - なるべく無停止で進めたい
  - 複数のサービスから参照されている
  - データベースリファクタリングの日本語版がない
    - Amazonで３万円
  - トリガーを使って肥大化したテーブルを分割する
  - MySQL5.6は１つのテーブルに同じイベントには複数のTriggerを付与できない
  - Aurora mySQL 5.6 -> RDS PostgresQL
    - Auroraを選ばなかった理由
    - Auroraは多分できるであろうなど情報が少ない
      - PostgreSQLとの互換性に関する情報が少ない
- AmazonDMSを選んだ理由
  - 異種間DBへのレプリケーション
  - オンプレ -> RDS
  - Aurora -> RDS
  - オンプレ -> Aurora (できる？)
  - Oracle Golden gate
    - 高い
    - OSSだとつらみがあるけどAWSの技術サポートが頼れる

- サービスを止めるな
  - 実際に運用してみてどうか
    - データ量が少ないなら簡単にできる
    - Amazon DMSが非同期レプリケーションなので2−３秒が遅れる
    - MySQLはローリングアップデートできる
    - PostgreSQL9 -> DMS -> PostgreSQL10
    - 遅延あるから全ての参照を
    - APIが遅スメの理由
      - IN/OUTがしっかりしているのでテストが簡単
      - 全て切り替えると問題が起こりやすいがモデル単位でのリリースを実現することで２中以降期間を作れる
    - Amazon DmSがローカル環境のテスト環境が用意できない
    - MySQL
    - 単一障害点
      - DMSが落ちるときはほぼない
      - RDSガファイルオーバーした際にDMSの向き先が指定的だに
    - Aurora PostgreSQL
      - postgresql.logをcloudwatchに送れない
      - RDS postgresqlはできるようになった

- Amazon DMSでタイムゾーンがUTCでずれる
  - JTCで設定したはずが、AWS側のアップデートでUTCになってしまってずれる

- まとめ
  - Amazon DMSは便利なツール
  - 価格が安い
    - 中規模RDS程度の価格
    - データセンターからの移行もできる
  - サービスの根底を刺させるのは不適切
  - @soudai1025
- MySQLはzerodateはPostgreSQLはinfinity, infinity mainus, 0001/01/01を設定した

## 技術力ってなんだっけ？

- エンジニアリングのアウトソーシング
  - 派遣、SESではない

- エンジニアリングってなんだっけ？
  - 自ら切り開くこと
  - 課題の発見と解決を想像・実現すること
- 実現のためにはエンジニアの技術力が重要
- MySQLの挙動がおかしいときにソースを読んで解決してきている
- 技術力ってなんでしたっけ？
  - 明確な定義はない
  - 技術者倫理？って本
- 技能
  - 知識・技術・倫理など総合的に判断できるようにすること
  - 価値観のズレが問題なのに知識を求めていても結果がともわない
  - 経験をただ積めばレベルが上がるわけではない
  - 資格が足しになるか？
    - 知識を得るためのアプローチ
  - AWSのホワイトペーパーに理念が書いてあり読むことで価値観をすり合わせることができる
- 新しい時代の技術者倫理って本がある

## GitHub Actionsを使って、ワークフローもプルリクベースで開発しよう！

- ikeike443
- GitHub Solutions Engineer

- Pull Request
  - 世界のソフトウェア開発が変わった
  - コラボレーションが行われている
  - OSSの世界から変わってきた

- workflowが統一されたplatformがあれば便利なんじゃないか
- Github Actions
  - github universで発表した
- ワークフローはモジュラー化されるべき
  - ニーズに応じて組み換えができる必要がある
  - これがgithub actions
  - ワークフローをコードとして管理しOSSとして公開、改善していくことができる

- demo
- 制限
  - 実行時間はMax59¥8ふん
  - ワークフローにつきアクションは100コマで
  - 並列実行は２つまで
  - APIは１時間に1000回
  - Secretはベータ期間中なので入れないでね
    - プロダクト利用はしないでね
  - Dockerなのでだいたいできる
  - exit statu 78は皇族は実行されないが、checksuiteはsuccessする

- EKSへのデプロイ
- callback
  - 近いことはできる
  - repository Dispatch
    - 外から任意にトリガーできるイベント
    - 長いジョブとかに有効
- Httpie
- Add an issue reference
  - ブランチ名からIssueを探し出してｌリンクする
- Probot app/Actions
- github Community ForumでActionsについて検討されている