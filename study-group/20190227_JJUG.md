# JJUG 20190227

## JVM言語の動き方・動かし方

- https://speakerdeck.com/miyakawataku/make-jvm-lang?slide=5

- Grall + Truffleがステキらしい
- 言語処理の勘所を知るためのやつ
- 言語処理系って何
  - 書かれたプログラムをコンピュータ上で実行するまでのソフトウェア一式
  - このセッションでの話ね

- 翻訳系
  - 実行に適した表現に変換すること
  - コンパイラ
  - AST抽象構文木
  - 多段階のデータ変換処理
  - 型検査や最適化などがトピック
- 実行系
  - 翻訳された結果を実行する
  - 誰が実行するの？
    - 機械語のプログラム
      - CPUとOSつまりコンピュータそのもの
    - 機械語以外
      - 実行系のプログラム
      - JVM, V8, YARV
      - コンピュータの真似事をする

- 本日は実行系がメイン

- OSの仕事: ローダー
  - プログラムが使う仮想アドレス空間を確保
  - 確保された空間にプログラムをロード

- CPUの仕事: 計算
  - 演算装置(ALU)

- 手続きの呼び出し
  - 高度のプログラムでは手続きの呼び出しを行う
  - RISC 5の場合
    - jal 命令で行われる

- スタックの確保
  - 呼び出し元のレジスタ値を退避しておく領域をスタック領域と呼ぶ
  - スタックの中身のやりくりはプログラムの責任

- 動的メモリ確保

- JVMはどのようにプログラムを動かすのか
  - javac
    - javaバイトコードの生成
  - java
    - javaバイトコードを実行する

- 実行系はコンピュータの真似をする、でも全く同じことをする必要はない
- webassembly
  - 各種言語をブラウザ上でうごかくための実行系のしよう

- オブジェクトシステム
  - コンピュータ, WebAssembly 存在しない
  - JVM Javaクラス & インスタンス

- メモリ管理
  - PC/ WA - GCは存在しない
  - JVM - 不要なオブジェクトはGC
- 手続きの呼び出し
  - PC/ WA アドレスへのジャンプ
  - JVM  クラスの仮想関数テーブルをルックアップ& ジャンプ
    - invokedyamic
- スタック
  - PC 他の呼び出しのフレームも読み書き可能
  - WA- JVM - 現在の呼び出しのフレーム以外は読み書きできない（保護されている）

- 計算
  - PC APU, アセンブラ
  - WA 項書き換え系
  - JVM　バイトコードインタプリタ & JITコンパイラ

- 項書き換え系
  - ルールにしたがって式の一部を書き換える
  - 項書き換え系で全てのプログラムが表せる
  - 利点
    - データと演算をひとまとめにするので理学的に扱いやすい
  - 欠点
    - 素直に実装すると遅い

- 計算: Metacircular Interpreter
  - ASTや木構造を再帰的にタグって計算を適用する
  - ASTを直接評価する

- 計算：バイトコードインタプリタ
  - 命令の抽象度が機械語より高い
  - 利点
    - Javaの場合、クラスファイルの内容が直接実行できる
    - スタックを自前で管理する場合、ホスト言語の制御構造ではできないことも実現できる
  - 欠点
    - PCよりも遅い

- JITコンパイラ
  - 実行系に内蔵された翻訳系のプログラム
  - 利点
    - 生成されたコードの実行は早い
  - 欠点
    - JITコンパイラの実行自体は重い
    - よく使われる箇所だけを対象とする方が効率がいい
      - HOTSPOT

- JVM言語処理系の構成
  - JVM言語処理系ってなに
    - 実行系がJVM上で動く言語処理系

- なぜJVM上で処理系を作るの
  - JVMにGCが任せることができるのは嬉しい
  - マルチスレッド系のGCを作ることはとても難しい

- 移植性
  - 作った処理系は環境に依存しない

- 性能
  - JITコンパイルのおかげで早い

- Java API
  - リッチなJava APIが使える
  - リフレクションのおかげで

- JVM言語の処理系
- kinkとその処理系
- オブジェクトシステムとメモリ管理


## GraalVMで使われている、他言語をJVM上に実装する仕組みを学ぼう

- GraalVM = Hotstop VM + α

- GraalVM
  - Grall(JIT Compiler)
  - Truffle()
  - Substrate VM

- Graal と　GraalVMは別物
- Top 10 Things to Do with graalVm
- polyglot 
  - 多言語実装
  - GraalにのっかているTruffle上でJS, R, Rubyとかが実行できる
    - Interpriterを実装する必要がある
    - 各言語ごとに必要となる
  - LLVM

- Truffle
  - 言語実装用のフレームワーク?ライブラリ
  - ASTにさえできれば GrallとJVMに実行を任せられる
  - Graalプロジェクトの一部

- レキサー/パーサー
  - ANTLR
    - なんか作れるらしい
    - ここから始めるといいらしい

- 塾ちょーのgithubにある
- Truffleでの言語実装
  - AST用ノードクラスを作成
    - 数値ノード
    - 演算子ノード(子ノード：オペランドが２つ)
    - 括弧ノード
  - アノテーションの種類、意味はJavadocを読むしかない（ドキュメントが整備されてない）
    - JITコンパイルの範囲を指定することもできる


## TruffleでPHPぽい言語を実装したら爆速だった

- jparsec
  - ANTLRの方が本格的に作れる
  - お試しで利用するくらいならちょうどいいかも

- GraalVM CE, EE
  - CE 無料版
  - EE 課金版
    - 課金方法は不明

