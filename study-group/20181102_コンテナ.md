# 20181102 コンテナに乗り遅れた人たちへ

## どこでも動くぞDocker!の落とし穴

- コンテナの話でよく見るシーン
  - 環境によって動かないという話がある
  - ホストデバイスが変わると動かない話

- NFCデバイスがDockerが認識できなかった 
- docker run　--device=/dev/bus
- 環境依存が発生

## コンテナに積み込もう - Docker入門から移行まで

- Google GCP カスタマーエンジニア
- GCPUG GCPユーザグループ
- lxc
  - Dockerの元となった技術
- gVisor ?
  - k8sとは別のオーケストレーション？

- Docker 以前
  - base と　アプリの境界がわかりにくい
  - 変更履歴が追いにくい

- Docker
  - imageの変遷が追いやすい

- コンテナ化の好いこと

- コンテナに移行しよう
  - アプリの種類は（Web, バッチ)
  - アプリのI/Oを正確に把握する
  - ポートは？
  - 必要なランタイムは？
    - 無駄なミドルウェアは入れない。
    - Docker image　が大きくならないようにしたほうがいい
  - 関連するプロセスはあるか？
    - 別プロセスになっている場合は、別コンテナにするがいい
  - 外部コンポーネントはあるか？
  - 本番はどうする？
    - １インスタンスに1 or N コンテナで運用してみる
    - オーケストレーションは後回し
    - コンテナが安定するのが先

- 実際に何をしたらいい？
  - ログ出力の見直し
    - 一旦、同じ場所に吐き出すでもいい
    - 標準出力にするでもいい
      - ログ収集基盤があるならの話
      - ログの設定変更などは追い追いでいい
  - アプリケーションの見直し(やらないですむならそれがいい)
    - モノリシックなアプリだったらコンテナイメージがでかくなるのを厭わずやる
      - DockerImageのサイズとかにこだわらずコンテナ化することが大切
    - マイクロサービス化することも大切
    - 最終的なイメージを持とう
  - Dockerfile を書く
    - ベースイメージの選定
      - 小さくするのは大切
      - 思わないところでつまずくこともあるので、UbuntuとかCentOSを使ったほうがいい
      - コンテナが毎回数ギガになるとストレージが足りなくなるよ
    - ランタイムのインストール方法
      - ランタイムが入った状態のベースイメージを作るところまでを頑張る
      - 泥臭くやるしかないね
    - 必要な設定があればDockerfileに書く
      - DB接続ファイルとかは変数要素や設定ファイルに吐き出しマウントするほうがいい
    - コンテナイメージロードマップ
      - まずはでかくてもImage化
      - ベースイメージを小さくしていく
        - 動作するために必要なライブラリだけに削ぎ落とす
        - ログ出力をログ基盤への出力に変更する
      - マイクロサービスにしていきましょう
  - 複数ノードのコンテナ管理の問題
    - マニュアル運用だと大変だからk8sを使おう
  - Container ON local -> Gontainer On IaaS -> Container on K8s

- コンテナのいミュータブルな状態を利用し、テストデータを入れたコンテナを作る


## プロダクションでDockerを動かす際にハマったこと（k8s Cluster Admin やってみました）

- k8s cluster adminとしてホスティング環境を提供
- k8s自体の管理
  - カーネル設定、ネットワーク設定
- Dockerfileの管理は開発者が行う
- Centos7.x でコンテナを動かしていた
  - Issue でつまる
- Container Linuxを目指している
- update時間がかかる問題
  - kubeadm -> Production非推奨
  - kubespray -> Updateに4時間
    - 独自にIaC化。それでも40分くらい
- Updateの安全性問題
  - サービスの瞬断が発生しうる状況(Istio)

- 権限管理問題
- Fat Image問題
  - Pullに時間がかかる
  - デプロイやスケールが遅い

- ネットワークの調整（10G）で対応
- 利用者に小さくしてもらうことを呼びかけた

- セキュリティ問題
  - NodeにSSH
  - ホストOSのdocker.sockは使用禁止
  - マルチテナントなのでPod間通信を抑制

- バージョンアップが早い
  - 3ヶ月にマイナーバージョンが上がる
  - キャッチアップが追いつかない
- Stateless or stateful (Storage)
  - statefullを求める理由は速度

- コンテナをプロダクションで動かす時は管理者/利用者に分ける
- コンテナとオーケストレーションが分けるべき
  - リソースの5から6割取られる
  - 管理者と利用者が混在すると開発に集中できない。

- マルチテナント/シングルテナント
  - マルチ
    - クラスタ数が少なくて済む
    - サーバリソースの有効活用
  - シングル
    - 権限管理が比較的楽
    - コンテナ間通信の防止が不要

- 心がけていたこと
  - とにかくtry & Error
    - 理屈もいいけど結果を早く知ろう
  - 早く失敗しよう
  - ミニマムにシンプルに始めよう 

## CircleCI で入門する Docke

- まずはHeroku対応からやってみるとコンテナ対応しやすい
- 開発環境
  - 徐々にコンテナ対応を進めればいい
- CI (Continuous Integration)
  - ユニットテストをコンテナで実行できる

- CircleCIからDockerを始めよう
  - 無料で始められる
  - 並列1コンテナのみ1000分/月
  - １コンテナあたり $50.00/月

- Docker Hub, Docker Cloud
  - Docker imageを管理しておく者
  - 相互参照できる
    - Docker Cloudはサードバーティだったのが買収されたやつ
  - Docker Cloudは他社のを参照できない
    - docker pull できちゃうよ

- https://github.com/codenize-tools/main

##　プルリク単位でステージング環境を作る docker, k8s

- 株式会社ベーシック
- itame, Capistrano
- Heroku Review Apps
  - なにこれ？
- 

- https://docs.google.com/presentation/d/1QujddBUmxWKVsAr6750klbH03vokzQR1sPRD7NsZtpg/edit#slide=id