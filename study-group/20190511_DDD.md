# 20190511 DDD

## ソフトウェアの核心にある複雑さに立ち向かう

- 核心ではないところでいかに手を向くかが肝心では？
  - 核心と核心じゃないもの分別をどうするか？
  - どのように決めていくか？

- ドメイン駆動設計の明確な狙いはファーストリリースではなく、以降の開発の変更を容易にしていくこと
- No More Legacy
  - 1年経過するばあっという間にレガシーになる
  - 5,6年ではなく、1,2年でレガシー化する

- アプリケーション層
  - ビジネスルールを含めない
- ドメインそう
  - ドメインロジックを記述する

- ドメインロジックとは？
  - ビジネスルール
  - 限定的に捉える
    - ビジネスの概念
      - 語彙
    - ビジネスの状況
      - ビジネスルールの実行の元になる事実
    - ビジネスルール
      - 金額、数量、期日、場所などの計算と判定
      - ビジネスルールを適用する条件による分岐
        - 顧客区分、商品種別

- ユビキタス言語
  - ビジネスルールを説明する語彙集
- ドメインエキスパート
  - ビジネスルールを具体的に知っている人
  - 新しいビジネスルールを作る際にはいない人
    - 新規サービス/プロダクトを作る場合は、エンジニア側からの発信や考える力が必要
    - 決めてくれれば作りますよ、if文は考えます

- トランザクションスクリプト
  - 入出力を行う手順が書いてあるだけ
  - ビジネスルールを中心に物事を考えようとすると、ルールが断片化し同じ判定処理が分散し変更が厄介になる

- 入出力の関心と計算を分離する
  - データの入力 -> データを使った計算や判定 -> 結果の出力

- 深いモデルを探求する
  - 最初から見つからない
  - 段階的に発見し、改善していく
  - 暗黙的な概念
    - なんとか言語化する
    - 言語化しないと改善に繋がらない
  - ぎこちない設計
    - コードの表現力を改善する
- ビジネスルールの中核を見定めて中核に集中する
- ビジネスルール全体の関係を俯瞰的に整理する

- 中核を見定めて、中核に集中する
  - ドメインビジョン声明文
    - 中核となるビジネスルール、ビジネスポリシーを自然言語で説明する
  - コアのハイライト
  - コアの分離
  - コアの抽象化


## 抽象的な教えを試行錯誤

- レビュー時に抽象的なフレーズが飛び交っている
- domain driven quickry
- アプローチ
  - 何から始めればいいかわからない
  - 名刺の抽出
    - 絵にする
    - クラス図
    - 結果データの箱にしかならんかった
      - 箱同士で線画引けない
- next
  - Domain層がスカスカなのかまずい
  - ドメインに集める
    - 処理順とか条件分岐によるDB更新とか外部システム連携が大事なもの(=ドメイン)だと思った
      - だって結合テストで利用するじゃん
  - 線は数本あるけどあんまり情報は増えていない
  - Domain層のテストコード描くのがものすごく大変
- next
  - 大事なものは更新処理じゃないみたいだ
  - 申し込みは変更処理しているけど、変更結果をreturnでもらえないからテストがしづらいのではないか
  - voidを無くそう
    - return するものや処理名から見直した方が良さそうだ
- 単語の抽出、同士を探す
  - voidをやめるにはreturnするクラスが必要だ、そのクラスは文書にある単語とは限らない
  - メソッドの整理は、IN/OUTの整理が必要となるのでドメインクラス同士が関係しだす
  - 業務をドメインで表す
    - ドメインクラスが何に依存して何を算出するか、その整理のこと
  - 振る舞えいを考える
    - ドメインクラスを算出するメソッド名のこと
- next
  - voidじゃないもの全てがドメインな訳でもないだろう
- 境界を決める
  - Domain層からApplication層やInfrastructure層からの依存を斷つ
- 知りすぎているドメインを切断した
  - メールを送信するのに不必要な情報を除外した
  - メールを送信するのにプランや料金を知る必要がない
- 依存性逆転の原則の適用

- 今後のやりたいこと


## DDDサンプルコード　ライブリファクタリング

- パッケージ内のクラス数が多すぎることが可視化を妨げる要因になるのかもしれない

## QualityとDeliveryを両立させるために僕らがやったこと

- 大規模案件で制約の中Quality高いものを作り維持し続けること
- 設計の工夫
  - アプリケーションアーキテクチャ
    - UI/UXとAPIを綺麗な状態で保つ
    - 原稿
      - Web 大量のビジネスロジック
      - API 役割が重複したやつ
      - Data
    - あるべき姿
      - API
        - DDDのドメインそう
        - ビジネスロジックの集約
    - WebとAPIの乖離
      - web-在庫
    - Orchestration層
      - ドメインとしてはプラント/料金の組み合わせだがAPIで統合するのは何か違う
      - Orchestrationそうを設けることでなんとかした
      - Spring service?
    - 先にDataを整理するのはリスク
      - TBL数、種類が複雑しすぎていてコストが高い
    - Integration
      - APIとDataSouceの複雑さを隠蔽するための層を設けた
　 - インプット
    - 書籍
      - エヴァンス本
      - オライリー
  - ワークショップに参加

- 役に立つ部品を探すのが最優先  - ドメイン層へのコンポーネント

- 登り方の工夫
  - 一括全面刷新はやらない
  - 品質的なリスク
  - 工期的なリスク
  - 案件にGoが出ない
  - スモールスタート
    - Myページを対象
    - 暗中模索
      - わからないこと不安が多すぎる
      - ローカル開発、新言語
      - 中心的に進める人と壁打ち役の選定
        - 技術力、PM力、サービス理解
        - わからないことがあると正解に近い回答がもらえる
        -　客観的なレビューができるいこと
    - 仕様書の喪失
      - DDDで書き起こすチャンスと捉える
      - ビジネスモデルの理解を進める
    - 新しいことがやりたすぎる
      - グッと堪える( +3個まで)
      - Deliveryの確度をたかめる
    - 対応コストをなるべく減らす
      - 完璧にやるコンポーネントと効率的にやるコンポーネントを分別する
    - 重要コンポーネントの定義の仕方
      - KPI貢献度 & 保守コストが高いものが重要
        - 斜陽だがKPI貢献しているもの = 効率的
    - 最終的にはシステムに組織を合わせたい

- 非エンジニアの同意と承認の工夫
  - ビジネスメリットで語るべき
    - サービスKPIにどう貢献するのか
  - 実績値で語るべき
  - 承認をどこで取るべきか
    - スモールスタート前
      - 実績値がないので困る
      - ビジネスメリット * 一般論でゴリ押し
      - スモールスタートして効果検証してFBすることもの約束
    - 実績の取り方
      - 刷新前後のシステム上でPDCAを回した