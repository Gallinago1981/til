# コンテナの事始めナイト

## Dockerコンテナとイメージ

- Factorio
- http://docs.docker.jp/
- Dockerとは
  - コンテナとはプロセスを簡単にコンテナ化(isolate)し簡単かつ素早く開発・移動・実行できるプラットフォーム
  - 仮想サーバは簡単に移動できない
    - ネットワーク帯域などインフラ周りの設定が簡単に移動できない
  - isolate(隔離・分離)
- Cloud Natebiとはなんなのか？
  - これまでの計算資源は特定の使う人が限られた環境で使うものだった
  - 止まると困るよね？
  - 生活がネットと繋がっていないと成りたたないこともある
  - アプリケーションをマイクロサービスに分割し各パーツ自身をコンテナにパッケージしリソース利用を最適化するために動的に統合ないしオーケストレートする
  - スマートフォンの普及に伴い365日24時間稼働が当たり前になってきた
    - 夜間リリースに伴う停止などが昔に比べてやりにくい状況になった
  - クラウドを使ったコンテナ、コンテナのオーケストレーションがいい感じ
- インフラの概念
  - ペット vs　家畜
  - 昔はサーバーマシンが高価だったので大事に使っていた (ペット)
  - クラウドで必要なリソースを得て、不要になったら捨てる （家畜）
  - スケールアップ（スペックアップ）からスケールアウトが主流になった
- システム基板も、サービス基盤も変わり続ける前提
- 混沌化したコンテ環境周りを定めた団体
  - Cloud Natie Computing Foundation (CNCF)
  - どこのクラウド環境でも動作するための基準を設けた
  - サーバーレスアプリケーションも同じ動きになっている
- Cloud nattive Landscape
  - コンテナオーケストレーションを行うための道筋が記載されている
  - 目的
    - プロセスとワークフローは結果的にこれらの環境を構築し苦痛を減らす
  - いきなりオーケストレーションするな
    - まずはアプリのコンテナ化が必須
    - k8sはコンテナ化されたアプリケーションが前提
    - CI/CD
      - これらをマニュアルで運用していては効果が薄い
    - オーケストレーションする
- マニュアルをwordpressで管理してた
  - マニュアルをforkさせた変更をwordpressさせるのは辛い
- たった一つの冴えたやり方ではない
  - ツールの導入が解決策ではない
  - コンテナはワークフロー上にどう乗せるかが重要

- Dokcerとは何か
  - 手元の環境と実行環境が異なる問題を包括する
  - 構築(build)・移動(ship)・実行(run)
  - Dockerコンテナを実行するにはイメージが必要
  - 全ての依存関係をパッケージ化しコンテナとして動かす
    - アプリを実行するために必要な設定ファイルなどを全部Dockerに入れる
  - DockerイメージとしてLinuxファイルシステムをパッケージ化する
  - 英語圏では小学生もDockerを使っている
  - Dockerは軽いと言われるが、仮想環境よりも軽い
    - 仮想ディスクが必要になるので数GBが必要になる
    - コンテナは仮想ディスクが不要
      - だから立ち上がりが早い、移動が早い
    - zabbixの新バージョンがでた
      - zabbixのDockerがある
      - docker logs -f
  - コンテナ禁止の会社はあかん

- docker image pull ( docker pull )
  - docker imageを取得してくるコマンド
  - library/XXXX が公式イメージを区別するポイントの１つ

- Alpine Linux
  - 非常に小さなLinuxディストリビューション。5Mしかない
  - コンテナで利用するにはいい感じ
  - gliderlabs / docker-alpine
  - DockerFileに1行1行がimage layer
    - apt installとかをまとめておいたほうがいい理由の１つか

- Dockerイメージはイメージ・レイヤの積み重ね

- Dockerコンテナは何か？
  - コンテナとして動かす
  - DockerコンテナはDockerイメージを実行
  - 実行は基本的にはReadOnlyで実行じに書き込み可能なレイヤーを追加している
  - Docker ≠ コンテナ
  - OS嬢のプロセスをisolate(分離)する
    - 大海の孤島のイメージ
    - 梱包ではない
  - プロセスなどを名前空間で分離しcgroupでリソースを割り当てる

- kubernetes
  - k8s
  - 8 は ubernete の部分

## Docker / k8sを活かすアプリ設計のポイント

- 今日はアプリよりな話
- コンテナは本番運用に使えるか？
  - 今日は結構使っている人が多い
- データ命なのにコンテナには永続性がない
  - コンテナはkillしたら無くなっちゃうよね？
  - k8sのpodも同様じゃん
- コンテナは使い捨て。ならばアプリ保守はどうする？
- データのバックアップはどうするの？
- チューニングどうするの？
- アプリのモジュールは？
- 動作保証どうするの？
- IBMはコンテナベースは許さん的なノリになっている
- コンテナの有効活用するには発想の転換が必要
  - ちょー重要
  - 発想転換を提唱したのが12Factor App
- 12 Factorとは
  - https://12factor.net/ja/
  - Heroku ?のエンジニアが描いたやつ

- コードベース
  - アプリも含めてコンテナ・リポジトリから各環境へデプロイを行う
  - buildを各環境で行わない

- 依存関係
  - アプリが依存する全てのパッケージをコンテナへインストールする
  - ミドルウェアをインストールするのではなく、docker pullしてrunするだけ

- 設定
  - 設定ファイルはデプロイしない。
  - k8sはクラスタの中に設定ファイルを配置する
  - 設定は環境から情報を取得する
  - CPUの利用上限を各クラスタに設定することができる
  - k8sは各環境のネームスペースを定義することができる
  - 永続ボリュームを与えるイメージ（何に？）
  - テスト環境から本番環境へコンテナを移動する場合に再ビルドが不要なようにすることが大切
  - 再ビルドすると欠陥が入ってくる可能性がある
    - だから、開発環境で動作したコンテナはそのまま本番環境へ移動する

- バックエンドサービス
  - データベースサービスは外部にしてもいい
  - 開発環境では内部サービスを構築してもいい
  - サービスは抽象化され内部外部を区別しない

- ビルド、リリース、実行
  - 3つのステージに分けよう

- プロセス
  - セッション情報は外にあるキャッシュサービスなど利用してアプリ・コンテナの突然の停止に備える必要がある
    - 例: ショッピングカートに商品を入れた場合、コンテナが停止してしまった場合に復元できない可能性がある。だから外部に情報をもつ
  - どうしてもキャッシュ使いたい場合はingressがある

- ポートバインディング
  - つなぎ先のpodを順次切り替えるなどができる

- 並列性
  - 縦軸 並列数
  - 横軸 リソース
  - スケールアップで対応するのか？数で対応するのか？ワークロードの種類でわける
  - ワークロードの種類に応じたデザインが必要

- 廃棄容易性
  - Javaアプリをビルドして立ち上げるまで時間がかかる
    - ライブラリが重いから仕方がない
  - ローリングアップデートをかけると、10個稼働していなきゃいけないルール上に20%までは非稼働を許容、20%までは余剰を許すなどの制御ができる
  - SIGTERMがとび、終了処理が実行されるが終わらないとSIGKILLされてしまう
    - 終了処理をちゃんと書いてディスクに書き出すとかが必要
    - 終了処理がないと次のアプリが起動できない
    - Docker の SIGTERM処理の書き方を調べよう！

- 開発/本番一致
  - OSのKernelは同じ
  - Linux kernelが変わると不要なバグを生む可能性がある

- ログ
  - ログのイベントストリームとして扱う
  - ローカルにログは書き出すな！
  - コンテナのログはSTDOUTへ出力
  - 標準出力されたログをfluentdでelastic searchへ入れるとか
    - kibanaでその状況を監視している
  - プロメテウス(Prometheus)
    - 時系列データベース
    - 他のやつだとRDBが入っている？トランザクションなんていらんぜ
    - 発生したイベントを時系列で保持する
  - podに監視ツールは入れない

- 管理プロセス

- マルチクラウドはもはや当たり前
  - 通信コストはどれくらいが許容されるのかとかが課題かな？
  - Watson API / IBM Cloudライトアカウント

## Ask the expert

- Docker ≠　コンテナ
  - Docker以外のコンテナ
  - linux コンテナの仕組みがある
  - coreos の　rocket
  - セカンドソースはある
  - docker以外を選ぶ理由は特にない
  - dockerの仕様が決まっていることが重要
  - だから、どこのクラウドでも動く
  - rocketが出てきても同じように動かなきゃ行かない
  - 差が出るとしたらセキュリティ！
  - コンテナはlinux kernelをガンガン読んでいるので、そこの箇所で差が出てくる

- docker for macにkubeminiが同伴しているけどk8sでもそのまま使えるのか？
  - まだ100%の互換性はないという認識
  - tensorflowは起動しなかった
  - k8s自体は変わらなくてもkernelが違う
  - コンテナの実行環境に依存する
  - HOST依存のGPUを使うとかになると注意することが必要
  - アプリからkernelからのつなぎこむには同じように注意しなくちゃいけない
  - Javaはやっぱり遅いけどclasspathdで悩む必要がないのは嬉しいよね

- k8sで本番サービスを動かしたいけどk8sの管理はしたくない。やっぱ、EKSやGKEになる？
  - さくらインターネットはない
  - IBM Cloud k8s サービスがある （2017年度に一番最初に動かしたのはIBM）
  - IBMはOSS戦略を取っている

- dockerのbuild時のバージョンと実行バージョンが異なる場合は再ビルドが必要か？
  - 現在は不要
  - ホスト側の環境が変わらないのであればが前提
  - 脆弱性アドバイザーがpublicなリポジトリに入っている
    - コンテナをビルドしたイメージに対して脆弱性をチェックする
    - 使い続けることよりも、脆弱性を含んだバージョンがあれば再ビルドを行った方がいい